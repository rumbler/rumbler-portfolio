name: Development Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - development

jobs:
  deploy-development:
    runs-on: self-hosted
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/checkout@v3
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: build
          path: dist/
      
      - name: Get commit hash
        id: commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Build Development Image
        run: |
          docker build \
            --build-arg NODE_ENV=development \
            -t portfolio:dev \
            -t portfolio:${{ steps.commit.outputs.hash }} \
            .
      
      - name: Deploy to Development
        run: |
          docker-compose down
          NODE_ENV=development \
          DOCKER_CPU_LIMIT=0.5 \
          DOCKER_MEMORY_LIMIT=128M \
          DOCKER_CPU_RESERVE=0.25 \
          DOCKER_MEMORY_RESERVE=64M \
          PORT=3001 \
          docker-compose up -d
          
          echo "Deployed version: ${{ steps.commit.outputs.hash }}"
          
      - name: Clean old images
        run: docker image prune -f --filter "until=24h"
